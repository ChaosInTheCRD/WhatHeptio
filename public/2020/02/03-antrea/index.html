<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Antrea: Giving My Pods A Voice | What the Heptio?</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="You know when you just stop and think... What the Heptio?"><link rel=prev href=http://whattheheptio.com/2020/02/post-0/><link rel=next href=http://whattheheptio.com/2020/03/04-prometheus/><link rel=canonical href=http://whattheheptio.com/2020/02/03-antrea/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:title content="Antrea: Giving My Pods A Voice"><meta name=twitter:description content="Hello World! Welcome back üéâ What a week (or two) it has been, full of yet more WTH moments. While there are many different cloud-native platforms, tools and services that I could centre this latest instalment around this week; I thought I‚Äôd take the opportunity to discuss an interesting project that I came across in my day to day life.
Whilst deploying my first kubeadm master node, I was faced with the decision of which pod network add-on to use üëÄ."><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Antrea: Giving My Pods A Voice","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/whattheheptio.com\/2020\/02\/03-antrea\/"},"image":{"@type":"ImageObject","url":"http:\/\/whattheheptio.com\/cover.png","width":800,"height":600},"genre":"posts","wordcount":1730,"url":"http:\/\/whattheheptio.com\/2020\/02\/03-antrea\/","datePublished":"2020-02-25T19:16:56\x2b00:00","dateModified":"2020-03-05T16:49:28\x2b00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Tom Meadows","logo":{"@type":"ImageObject","url":"http:\/\/whattheheptio.com\/logo.png","width":127,"height":40}},"description":""}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.min.css><link rel=stylesheet href=/css/lib/animate/animate.min.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=http://whattheheptio.com>What the Heptio?</a></div><div class=navbar-menu><a class=menu-item href=http://whattheheptio.com/posts>Posts</a>
<a class=menu-item href=http://whattheheptio.com/tags>Tags</a>
<a class=menu-item href=http://whattheheptio.com/categories>Categories</a>
<a class=menu-item href=http://whattheheptio.com/about>About</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=http://whattheheptio.com>What the Heptio?</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=http://whattheheptio.com/posts>Posts</a>
<a class=menu-item href=http://whattheheptio.com/tags>Tags</a>
<a class=menu-item href=http://whattheheptio.com/categories>Categories</a>
<a class=menu-item href=http://whattheheptio.com/about>About</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw"></i></a></div></div></nav><main class=main><div class=container><article class=post-warp><h1 class="post-title animated flipInX">Antrea: Giving My Pods A Voice</h1><div class=post-meta><div class=post-meta-main><a class=author href=http://whattheheptio.com rel=author><i class="fas fa-user-circle fa-fw"></i>Tom Meadows&nbsp;</a></div><div class=post-meta-other><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-02-25>2020-02-25</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 1730 words&nbsp;
<i class="far fa-clock fa-fw"></i>9 min&nbsp;</div></div><div class=post-content><p>Hello World! Welcome back üéâ What a week (or two) it has been, full of yet more WTH moments. While there are many different cloud-native platforms, tools and services that I could centre this latest instalment around this week; I thought I‚Äôd take the opportunity to discuss an interesting project that I came across in my day to day life.</p><p>Whilst deploying my first <a href=https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/>kubeadm</a> master node, I was faced with the decision of which pod network add-on to use üëÄ. Of course, WTH I thought. Yet another moment that I had my false sense of understanding extinguished üßØ. After doing a little bit of searching on the internet, I just found a bunch of people yelling &lsquo;use calico, it just works&rsquo;, so I decided heck why not, let&rsquo;s just do it.. I applied the yaml file I was prompted with, and away I went.</p><figure><img src=/img/Antrea-03/KubernetesComic2.png><figcaption><h4>Ok sure, the 'containers anywhere' model sounds great.. but how do they network? It can't be magic...</h4></figcaption></figure><p>Fast forward a couple of days, and I heard the word &lsquo;Antrea&rsquo;. If you&rsquo;ve not figured it out by now, names like Tanzu, Octant, Istio, Helm, Prometheus and Antrea, have a certain ring to them that makes the mind go &lsquo;definitely some open-source project related to Kubernetes&rsquo;. So of course I start asking more questions, and it turns out that Antrea is a pod networking add-on for Kubernetes; just in the way that Calico is ü§î. It was at this point that I thought, &ldquo;ok sure&mldr; it seems that I must take the time to understand what this whole pod network add-on business means in the world of cloud-native, and work out what is going on&rdquo;. So good news, I&rsquo;m going to drag you all along with me, let&rsquo;s go!</p><a class=post-dummy-target id=brief-side-note></a><h3>Brief Side-Note</h3><p>The aim of this blog as a whole is to make it inclusive for all, so in my <a href=https://whattheheptio.com/2020/02/first-posts/>first post</a>, I added some links/content that step through the basics of containers and kubernetes. So don&rsquo;t fear, exciting content that will explain all is only a few clicks away!</p><a class=post-dummy-target id=what-the-heptio-is-pod-networking-></a><h2>What the Heptio is Pod Networking? üîó</h2><p>So we&rsquo;re back to Kubernetes again (surprise, surprise). And this time we&rsquo;re taking a look at pod networking. So far in my Kubernetes voyage (sailing pun intended), I have tried to wrap my head around what every kubernetes object is, and how it stitches together. To be frank with you all, asking questions such as &lsquo;how do pods get assigned IPs&rsquo; was not at the top of my list of curiosities üòÇ. As far as I was concerned initially, I started minikube or GKE, and all the networking just folded silently into the background.</p><p>At a basic level, container networking is a mechanism through which containers can <em>optionally</em> connect to other containers, hosts and external networks, like our good friend the internet. Simple capabilities are provided by our base layer container runtimes such as docker üê≥, but more advanced capabilities require additional drivers and plugins. Of course, on a platform such as kubernetes, designed to allow people to command, control, connect, and mould their micro-services in any which way they like, a smart networking solution is of high importance.</p><p>So in a world where processes are spinning up, spinning down, shifting and changing all the time, in multiple places; a framework is required to manage and configure their networking. In a model like this it&rsquo;s required, as quite frankly&mldr; I don&rsquo;t back myself to keep up with the management of this stuff&mldr; do you? Therefore the container runtime utilises something called a Container Networking Interface (CNI), to handle all of this chaos!</p><figure><img src=/img/Antrea-03/Alternatives.png><figcaption><h4>Options for a CNI... Besides Antrea üôÉ</h4></figcaption></figure><p>These plugins provision and manage the IPs of the containers within the runtime, and get informed when said container dies, so resources can be cleaned up. Of course the IPs provisioned for the containers are of a different format to what is seen for the hosts sitting on your home-lab network for instance. While your physical host that is running Kubernetes may have an IP subnet of &lsquo;192.168.0.0/16&rsquo;, your pod network will likely use a subnet of the form &lsquo;10.244.0.0/16&rsquo; (this is what mine uses üòÑ). so this begs the question&mldr; &ldquo;sure, two pods in a node can easily have a chat with one another&mldr; but what if that pod wants to talk to the node on their network&mldr; or even worse, what if they want to talk to a pod on another node ü§Ø?&rdquo; Well, the plugin helps us out here by establishing a &lsquo;veth&rsquo; virtual interface pair. one situated in the local pod network namespace,and another on a &lsquo;bridge&rsquo;, sitting in the hosts namespace. The bridge is a virtual switch that is capable of forwarding traffic between network segments, as we discussed above. I like to visualise these links sat on a bridge as akin to those gateways in stranger things between the real world and the upside down&mldr; except in this case we&rsquo;re travelling between network namespaces. If you haven&rsquo;t watched it then my compelling argument for you to is right there ‚úä.</p><figure><img src=/img/Antrea-03/upsidedown.gif></figure><p>After copious amounts of effort, I have taken the time to create a diagram that I feel describes this mystical situation below without (too much) complexity. Let&rsquo;s envision a scenario where we have configured two nodes to run our containerised workloads on; workload 1 and workload 2. As you can see in the diagram, each node is connected to a router on the private network with a subnet of 192.168.0.0/24, and have been leased an IP with DHCP. Say for example that in this instance, we have kubernetes installed to orchestrate the containers, have deployed each workload so they run on a separate node (node 1 and 2). Now upon using kubectl to feel like a wizard and magically get container networking configured on our cluster of nodes. In reality, a few things are actions are being executed (unfortunately you&rsquo;re not a real wizard yet). The containers on each node are assigned a unique IP within the subnet range of the container network namespace (this can be declared by the user upon install). After some investigation of my own cluster, the 3rd octet of each pods IP corresponds to the node they&rsquo;re running on (e.g. 10.244.<strong>1</strong>.18 for node 1), pretty neat. Now what also happens, is a <a href=https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/>Daemonset</a> is created by the CNI installer. This is an object declaration that ensures all nodes run a copy of a certain pod. In the diagram, this is where our &lsquo;CNI-Pod&rsquo; comes from üòé. This is the component that handles the declaration of the bridge interface (dark blue looking object in diagram), so that the containers can leak out their packets to the big bad world ü•¥!</p><p>A lot to take in? I know. Don&rsquo;t worry though, I also didn&rsquo;t quite get it the first time either (hence missing last weeks post ü•ä). I will also embed a video at the bottom of the page that I found helpful.</p><figure><img src=/img/Antrea-03/CNIDiagram.png></figure><a class=post-dummy-target id=ok-ok-thats-enough-tell-me-about-antrea></a><h2>Ok ok, that&rsquo;s enough. Tell me about Antrea</h2><p><em>Before we dive in, I just thought i&rsquo;d mention that the public Github repository for Antrea is available <a href=https://github.com/vmware-tanzu/antrea>here</a>. The project is still very young, and they&rsquo;re looking for members of the open-source community to join in and contribute. Are you what they&rsquo;re looking for? Go check it out. If not, you should definitely still check out the README</em> üôÇ.</p><figure><img src=/img/Antrea-03/Antrea.png></figure><p>So, where was I&mldr; aha &lsquo;Project Antrea&rsquo;. released as a part of the portfolio of open-source projects spearheaded by VMware under the guise &lsquo;Tanzu&rsquo;, this networking solution is developed primarily for the kubernetes platform, and works very much in the same way as described in the muddled up collection of words in the previous section. So how is it different to previous CNIs? Well, Antrea harnesses a multilayer (OSI layer 2-7) virtual switch software called Open vSwitch to handle the data plane, operating at layer 3/4. In other words the virtual interfaces (veth and bridge) mentioned above are in this case handled using OVS. The benefits brought about by using such a technology within the CNI are:</p><ul><li>High Performance. Technologies that aim to optimise data flow at every level, from data-link layer up to application layer have been used to optimise this technology to transmit packets as quickly and efficiently as possible.</li><li>Portability. One fantastic thing about OVS is it&rsquo;s support for any platform; including windows, Linux and any cloud distribution. This is great for enterprise users with a plethora of different environments that are communicating with one another.</li><li>Operations. Through the design of OVS, Antrea is able to provide metrics for many existing monitoring tools and protocols (such as Prometheus?&mldr; OK not yet&mldr; more content on this coming soon üò≤).</li><li>Flexibility and Extensibility. OVS allows the user to create an overlay network for there cluster based on a number of protocols, such as VXLAN, Geneve, GRE and STT. This gives the user a lot of power if they have particular compatibility needs for the infrastructure that sits beneath (<em>casual wink to VMware NSX</em> üòâ).</li></ul><p>One final feature that I think is worth noting is a plugin for <a href=https://github.com/vmware-tanzu/octant>Octant</a>, which is a platform for developers to easily view and better understand a kubernetes cluster through a beautiful UI ü§ó. Of course, this is also provided by VMware, and it is very easy to deploy, and I recommend that you play with it if you have a cluster for it to utilise.</p><figure><img src=/img/Antrea-03/octant-demo.gif></figure><a class=post-dummy-target id=wrapping-up-></a><h2>Wrapping Up üéÅ</h2><p>Ok, so we have battled through the (somewhat) magical way that kubernetes pods get allocated a subnet, and moreover their own individual IP address so that they really can function automatically all over the world. But we&rsquo;ve also taken a look at project Antrea, and demystified that &lsquo;WTH&rsquo; moment that I encountered just a couple of weeks ago.</p><p>My learning on the subject of container networking is still developing, so I hope that this post made enough sense to be useful, and as always brought some benefit to your life. If so, any comments or feedback would be heavily appreciated, and if you spot any errors or things to correct, the same goes.</p><p>I will sign out by embedding a YouTube video (as promised) of a KubeCon conference presented by Kristen Jacobs from Oracle titled &lsquo;Container Networking from Scratch&rsquo;. This helped me greatly in getting my head around the basic concepts, so thought it would be worth referencing.</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube-nocookie.com/embed/6v_BDHIgOY8 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>This article is updated with 2020-03-05</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=http://whattheheptio.com/2020/02/03-antrea/index.md target=_blank></a></span></div><div class=post-info-share><span><a href="//reddit.com/submit?url=http%3a%2f%2fwhattheheptio.com%2f2020%2f02%2f03-antrea%2f&title=Antrea%3a%20Giving%20My%20Pods%20A%20Voice" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a><a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2fwhattheheptio.com%2f2020%2f02%2f03-antrea%2f&title=Antrea%3a%20Giving%20My%20Pods%20A%20Voice" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin fa-fw"></i></a></span></div></div></div><div class=post-info-more><section></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=http://whattheheptio.com>Home</a></span></section></div><div class=post-nav><a href=http://whattheheptio.com/2020/02/post-0/ class=prev rel=prev title="WTH Post 0: Peeking Behind the Curtains üïµüèª‚Äç‚ôÇÔ∏è"><i class="fas fa-angle-left fa-fw"></i>WTH Post 0: Peeking Behind the Curtains üïµüèª‚Äç‚ôÇÔ∏è</a>
<a href=http://whattheheptio.com/2020/03/04-prometheus/ class=next rel=next title="Prometheus and Grafana: The Metric Monitoring Titans">Prometheus and Grafana: The Metric Monitoring Titans<i class="fas fa-angle-right fa-fw"></i></a></div></div><div class=post-comment><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")
return;var dsq=document.createElement("script");dsq.type="text/javascript";dsq.async=true;var disqus_shortname="whattheheptio";dsq.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=http://whattheheptio.com>Tom Meadows</a></span><span class=license>&nbsp;|&nbsp;<a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer><script src=/js/lib/jquery/jquery.slim.min.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><script src=/js/blog.min.js></script></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a></body></html>