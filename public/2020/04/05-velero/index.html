<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>When disaster strikes, count on... Velero? | What the Heptio?</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="How can Velero save your bacon?"><link rel=prev href=http://whattheheptio.com/2020/03/04-prometheus/><link rel=canonical href=http://whattheheptio.com/2020/04/05-velero/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:title content="When disaster strikes, count on... Velero?"><meta name=twitter:description content="How can Velero save your bacon?"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"When disaster strikes, count on... Velero?","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/whattheheptio.com\/2020\/04\/05-velero\/"},"image":{"@type":"ImageObject","url":"http:\/\/whattheheptio.com\/cover.png","width":800,"height":600},"genre":"posts","keywords":"Kubernetes, Tools, Disaster Recovery","wordcount":1880,"url":"http:\/\/whattheheptio.com\/2020\/04\/05-velero\/","datePublished":"2020-04-16T16:16:01\x2b01:00","dateModified":"2020-04-22T16:41:27\x2b01:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Tom Meadows","logo":{"@type":"ImageObject","url":"http:\/\/whattheheptio.com\/logo.png","width":127,"height":40}},"description":"How can Velero save your bacon?"}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.min.css><link rel=stylesheet href=/css/lib/animate/animate.min.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=http://whattheheptio.com>What the Heptio?</a></div><div class=navbar-menu><a class=menu-item href=http://whattheheptio.com/posts>Posts</a>
<a class=menu-item href=http://whattheheptio.com/tags>Tags</a>
<a class=menu-item href=http://whattheheptio.com/categories>Categories</a>
<a class=menu-item href=http://whattheheptio.com/about>About</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=http://whattheheptio.com>What the Heptio?</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=http://whattheheptio.com/posts>Posts</a>
<a class=menu-item href=http://whattheheptio.com/tags>Tags</a>
<a class=menu-item href=http://whattheheptio.com/categories>Categories</a>
<a class=menu-item href=http://whattheheptio.com/about>About</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw"></i></a></div></div></nav><main class=main><div class=container><article class=post-warp><h1 class="post-title animated flipInX">When disaster strikes, count on... Velero?</h1><div class=post-meta><div class=post-meta-main><a class=author href=http://whattheheptio.com rel=author><i class="fas fa-user-circle fa-fw"></i>Tom Meadows&nbsp;</a>
<span class=post-category>included in
<i class="far fa-folder fa-fw"></i><a href=http://whattheheptio.com/categories/tools-and-platforms/>Tools and Platforms</a></span></div><div class=post-meta-other><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-04-16>2020-04-16</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 1880 words&nbsp;
<i class="far fa-clock fa-fw"></i>9 min&nbsp;</div></div><div class=post-featured-image><img src=/images/loading.svg data-sizes=auto data-src=/img/05-Velero/veleros.jpg alt="featured image" class=lazyload></div><div class=post-content><p>The open source tool that makes backing up your Kubernetes Cluster plain sailing!</p><a class=post-dummy-target id=todays-post-anthem></a><h5>Todays Post Anthem</h5><div align=centre><iframe src=https://open.spotify.com/embed/track/6yfnmzXX7TQ3sfjr7jUNtb width=300 height=80 frameborder=0 allowtransparency=true allow=encrypted-media></iframe><p>Well surprise surprise, it looks like I&rsquo;m back! Not at all the length of time that I was planning to be away for, but certain events (that I&rsquo;m sure you will not want to spend another minute hearing about) led me to put our curious voyage together through the mystical universe of cloud-native, on the back burner for a little while. Now now, of course that does not mean that I haven&rsquo;t been exploring further; in fact, quite the contrary.</p><a class=post-dummy-target id=so-what-have-i-been-up-to></a><h3>So what have I been up to?</h3><p>That&rsquo;s a great question! The past few weeks has actually given me a considerable amount of time to play around with a selection of different projects; some of them more productive than others; but alas, many of them could very happily overviewed on this blog, without having me veer too far off topic. Hopefully over the next few weeks, I will take strides to write some chapters on WTH explaining them. To tease your taste buds, here is a sneak preview of what I have been up to:</p><ul><li>Migration of Kubernetes workloads away from GCP, onto a freshly squeezed kubeadm-based home server üçã</li><li>The curious case of the kettle in the kitchen that corrupted the single-node etcd cluster üîå‚ö°Ô∏è</li><li>Redesigning Kubernetes to be a Highly available, medusa-like god figure ü¶πüèª‚Äç‚ôÄÔ∏è</li><li>Securing Dashboards with OAuth2 Proxy magic üêá</li></ul><a class=post-dummy-target id=enough-chit-chat-tell-me-about-velero></a><h2>Enough chit chat, tell me about Velero</h2><p>Okay, okay I hear you, listening to my invalid excuses isn&rsquo;t much fun for anyone. But funnily enough, neither is system failure. And what&rsquo;s worse than system failure? I&rsquo;ll tell you for free; system failure with no disaster recovery solution! No disaster recovery solution, mitigation, or protection, for the kubernetes empire that you have worked tirelessly to setup over many months, if not years. But this begs the question; if your workloads are running in ephemeral containers, why not treat your cluster as an ephemeral beast as well?</p><a class=post-dummy-target id=ephemeral-what-the-heptio></a><h3>Ephemeral? What the Heptio?</h3><p>In the world of cloud native, containers by and large are treated to be ephemeral entities. In essence, this means their lifetime is viewed to be very short, before dying a valiant death. For this reason, data that we want to persist after a said death, to be used by the next container that comes along, is given its own dedicated resource to live in. For Kubernetes, this resource is called a persistent volume (PV), and solves many headaches. Try deploying <a href=https://whattheheptio.com/2020/03/04-prometheus/>Grafana</a> dashboards on Kubernetes without any persistent storage; you&rsquo;ll see what I mean!</p><a class=post-dummy-target id=and-my-kubernetes-manifests-where-are-they-stored-></a><h3>And my Kubernetes Manifests&mldr; Where are they stored? üíæ</h3><p>Aha! now you&rsquo;re asking some important questions. The Kubernetes <a href=https://devspace.cloud/docs/cli/deployment/kubernetes-manifests/what-are-manifests>manifests</a>, are a big stack of yaml files that are presented to the API server. They describe the what, when, how and why of every application running on the cluster, and are stored on a database called <a href=https://etcd.io/>etcd</a>. Without going into this too deeply (I shall save it for another instalment), this a distributed, reliable key-value store; that is accessible cluster-wide. Due to its distributed nature, etcd usually runs in a cluster model of multiple nodes; just like kubernetes. Most commonly, this cluster is set up as a selection of docker containers. Containers everywhere!</p><p>So what happens when you have a single node etcd cluster that has its data corrupted? What happens when the power goes out in your house, and you power your cluster back on to find that your etcd node isn&rsquo;t responding? Well, of course i&rsquo;m talking from experience, so I can tell you. You cry for a while, and then get up and say; looks like we&rsquo;ll have to just build all over again.</p><figure><img src=/img/05-Velero/sandcastle.gif><figcaption><h4>What happened to my old cluster? üò≠</h4></figcaption></figure><a class=post-dummy-target id=planning-for-the-inevitable></a><h3>Planning for the inevitable</h3><p>Well guess what, in the world of Kubernetes, disaster recovery is not something you should think about on day 2, or day 1&mldr; it should be thought out and implemented on day 0. The beauty of treating your containers as ephemeral, is that they can fail relatively frequently, and kubernetes will spin up new ones to take their place; mounting the persistent data in the appropriate places. But as highlighted by the etcd anecdote&mldr; my cluster would maybe benefit from taking some inspiration from this &lsquo;live fast, die young&rsquo; attitude that the containers it runs have adopted. Its about time we designed our cluster with failure in mind. Wouldn&rsquo;t it be great to have our Kubernetes resources declaratively backed up in an automated fashion. Sounds great! Well&mldr; I hear you thinking &ldquo;What the Heptio? How do I do that?"&mldr; Velero, take centre stage.</p><a class=post-dummy-target id=please-dont-you-rock-my-boat-></a><h2>Please don&rsquo;t you rock my boat ‚õµÔ∏è</h2><figure><img src=/img/05-Velero/velero.png></figure><p>So we have deployed our highly-available kubernetes cluster; and we stand triumphantly over our containerised splendor&mldr; 3 master nodes, ready to serve our army of workers deployed beneath them, whatever the weather. But just in case our cluster can&rsquo;t quite handle the storm, let <a href=https://velero.io>Velero</a> be your vessel to guide you through.</p><p>Giving you the capability to schedule automatic backups at recurring intervals, you can direct this tool to store a copy of whatever Kubernetes resource you desire. Whether it be persistent volumes, all namespaces, specific namespaces, the whole cluster with every nook and cranny; you name it, you can do it. The tool then enables the user to restore these resources back to the cluster at any time. The tool also supports the migration of these resources to other clusters, so you can save yourself the headache of starting from scratch with every new kubernetes instance.</p><a class=post-dummy-target id=but-where-are-those-backups-going-></a><h3>But where are those backups going? ü§î</h3><p>Good question. These backups are capable of going to a selection of supported object stores, from an array of public cloud and on-premise storage providers. These include AWS S3, Google Cloud Storage, Portworx and OpenEBS. What intrigued me most is, some third-party S3-compatible object store providers also work. So I was able to set this up to for my <a href=https://min.io/>Minio</a>, and avoid those nasty public cloud prices ü§≠.</p><a class=post-dummy-target id=so></a><h3>So&mldr;</h3><p>It sounds like this is the solution to all our problems! So how do we use it? Does it work as expected?&mldr; Lets find out.</p><a class=post-dummy-target id=time-to-give-it-a-whirl-></a><h2>Time to give it a whirl üåÄ</h2><p>So if you have a look at the <a href=https://velero.io/docs/v1.3.2/index.html>overview</a> documentation, we can see that Velero uses a client-server architecture, deploying a server that runs on the cluster upon install, after a client binary has been setup on the users local machine.</p><p>The basic install shows us that we can simply go ahead and install Velero on any machine that has kubectl access to the cluster you want to backup. I used MacOS, so installed the Velero client tool with the <a href=https://brew.sh/>brew</a> package manager. Otherwise, the <a href=https://github.com/vmware-tanzu/velero/releases/latest>latest release</a> tarball for your platform can be downloaded from Github.</p><p>From there, you need to setup and configure the object store, choosing from the list of providers mentioned above. I used minio, which provides AWS S3 compatible storage.</p><p>You will then need to perform a <code>velero install</code> command from your chosen client, with added parameters that describe your object store location. In my case the <code>install</code> command with flags looked like the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>what@heptio:~$ velero install \    
    --provider aws \ # name of provider
    --plugins velero/velero-plugin-for-aws:v1.0.0 \ # the plugin velero needs to use for minio
    --bucket velero \ # the name of the minio bucket
    --secret-file ./credentials-velero \ # the credentials for the minio server to be stored in a secret
    --backup-location-config region=minio,s3ForcePathStyle=&#34;true&#34;,s3Url=http://192.168.0.210:9000 # specifying the location of the bucket (region and IP)
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=success-now-what-to-backup-first></a><h3>Success! Now what to backup first&mldr;</h3><p>So now there should be a namespace on the cluster called <code>velero</code>, and the command <code>velero get backup-locations</code> should list the object store of your choosing üòé.</p><p>Now this is where things get really slick. So we need something to backup that will test the power this tool really wields, right? Well I thought to myself; how about that <a href=https://www.weave.works/oss/scope/>Weave Scope</a> namespace I have lying on my cluster, that I haven&rsquo;t really had the time to mess with yet. Sounds good. worst case; no important config lost üôÇ.</p><a class=post-dummy-target id=1-creating-the-backup-before-wreaking-havoc-></a><h4>1. Creating the backup before wreaking havoc üß®</h4><p>As seen in the animation below, creating the backup is a simple case of telling the client: the name of the backup, and what resources should be included within it. Once this has been carried out, you should be notified that your backup request has been submitted, hurrah! You can then call <code>velero get backups</code> to check that it has completed successfully. Bare in mind that the time to backup after submission will depend on the size of the resources being backed up, as well as the network connection to the object store.</p><p>Once the backup is shown as <code>Completed</code>, you can go ahead and start creating problems for yourself. <code>kubectl scale deployment chaos-monkeys --replicas=1000</code> begins to ring in your eardrums üòº.</p><figure><img src=/img/05-Velero/velero-backup.gif></figure><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>what@heptio:~$ velero create backup weave --include-namespaces weave 
# creates the backup
what@heptio:~$ velero get backups
# fetches the backups, and shows their status
what@heptio:~$ kubectl delete ns weave
# deletes the namespace... let the chaos begin
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=2-dont-panic-and-fall-back-on-velero-></a><h4>2. Don&rsquo;t panic, and fall back on Velero üôÜ‚Äç‚ôÇÔ∏è</h4><p>So we&rsquo;ve deleted the namespace, its time to panic. In fact no, it certainly is not time to panic. You were cunning, and planned for disaster on day 0, rather than day 2! Lets make the magic happen.</p><p>As shown in the animation below, I have lost the namespace <code>weave</code>, and if I don&rsquo;t get this sorted now; I will be crying myself to sleep, knowing that my users are unable to view the cluster resources zipping around in real time (don&rsquo;t worry, i&rsquo;ll do a post on Scope at some point; it&rsquo;s really cool).</p><p>Fear not! We created our backup with Velero, and we&rsquo;re not afraid ot use it. A simple <code>velero restore create</code> command is all it takes; and before you know it&mldr; look! Your namespace is right back where you left it! No <code>CrashLoopBackoffs</code>,<code>Pending</code> or <code>Error</code> pod statuses to worry about here üëå.</p><figure><img src=/img/05-Velero/velero-restore.gif></figure><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>what@heptio:~$ velero restore create --from-backup weave
# All we need to get &#39;backup&#39; and running üòè
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=wrapping-up></a><h2>Wrapping up</h2><p>So. Thank you for following along my anecdotal overview of Velero, and how I managed to stumble upon a truly magnificent tool, that has already saved my bacon a couple of times. The best part is that I have only scratched the surface of what Velero is capable of, and I will leave it to you with regards to taking your disaster recovery journey further into the abyss ‚ú®.</p><p>As is tradition with these posts, I have chosen a video that would be worth watching if you want to dive further into the topic in a more practical fashion - check out the TGI Kubernetes Episode at the bottom of the page. It&rsquo;s definitely worth a watch.</p><p>Finally, a big thank you to members of the Velero team that helped me with some of the finer details within this post. I would also like to shout out a podcast hosted by one of the Engineers for Velero, Carlisia Campos. <a href="https://www.youtube.com/playlist?list=PL7bmigfV0EqSh-btGOy8BLG3lsF0ylfZ-">The Podlets</a> is a weekly video podcast, where Carlisia and guests explore cloud native, one buzzword at a time.</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube-nocookie.com/embed/tj5Ey2bHsfM style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>This article is updated with 2020-04-22</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=http://whattheheptio.com/2020/04/05-velero/index.md target=_blank></a></span></div><div class=post-info-share><span><a href="//reddit.com/submit?url=http%3a%2f%2fwhattheheptio.com%2f2020%2f04%2f05-velero%2f&title=When%20disaster%20strikes%2c%20count%20on...%20Velero%3f" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a><a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2fwhattheheptio.com%2f2020%2f04%2f05-velero%2f&title=When%20disaster%20strikes%2c%20count%20on...%20Velero%3f" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><span class=tag><a href=http://whattheheptio.com/tags/kubernetes/><i class="fas fa-tag fa-fw"></i>Kubernetes</a></span>
<span class=tag><a href=http://whattheheptio.com/tags/tools/><i class="fas fa-tag fa-fw"></i>Tools</a></span>
<span class=tag><a href=http://whattheheptio.com/tags/disaster-recovery/><i class="fas fa-tag fa-fw"></i>Disaster Recovery</a></span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=http://whattheheptio.com>Home</a></span></section></div><div class=post-nav><a href=http://whattheheptio.com/2020/03/04-prometheus/ class=prev rel=prev title="Prometheus and Grafana: The Metric Monitoring Titans"><i class="fas fa-angle-left fa-fw"></i>Prometheus and Grafana: The Metric Monitoring Titans</a></div></div><div class=post-comment><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")
return;var dsq=document.createElement("script");dsq.type="text/javascript";dsq.async=true;var disqus_shortname="whattheheptio";dsq.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=http://whattheheptio.com>Tom Meadows</a></span><span class=license>&nbsp;|&nbsp;<a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer><script src=/js/lib/jquery/jquery.slim.min.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><script src=/js/blog.min.js></script></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a></body></html>