<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Prometheus and Grafana: The Metric Monitoring Titans | What the Heptio?</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=Description content="How can Velero save your bacon?"><link rel=prev href=http://whattheheptio.com/2020/02/03-antrea/><link rel=next href=http://whattheheptio.com/2020/04/05-velero/><link rel=canonical href=http://whattheheptio.com/2020/03/04-prometheus/><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=twitter:card content="summary"><meta name=twitter:title content="Prometheus and Grafana: The Metric Monitoring Titans"><meta name=twitter:description content="How can Velero save your bacon?"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Prometheus and Grafana: The Metric Monitoring Titans","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/whattheheptio.com\/2020\/03\/04-prometheus\/"},"image":{"@type":"ImageObject","url":"http:\/\/whattheheptio.com\/cover.png","width":800,"height":600},"genre":"posts","keywords":"Kubernetes, Tools, Monitoring","wordcount":1770,"url":"http:\/\/whattheheptio.com\/2020\/03\/04-prometheus\/","datePublished":"2020-03-04T11:00:56\u002b00:00","dateModified":"2020-04-22T17:27:48\u002b01:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Tom Meadows","logo":{"@type":"ImageObject","url":"http:\/\/whattheheptio.com\/logo.png","width":127,"height":40}},"description":"How can Velero save your bacon?"}</script><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/css/lib/fontawesome-free/all.min.min.css><link rel=stylesheet href=/css/lib/animate/animate.min.min.css></head><body><script>window.isDark=(window.localStorage&&window.localStorage.getItem('theme'))==='dark';window.isDark&&document.body.classList.add('dark-theme');</script><div class=wrapper><nav class=navbar><div class=navbar-container><div class="navbar-header animated bounceIn"><a href=http://whattheheptio.com>What the Heptio?</a></div><div class=navbar-menu><a class=menu-item href=http://whattheheptio.com/posts>Posts</a>
<a class=menu-item href=http://whattheheptio.com/tags>Tags</a>
<a class=menu-item href=http://whattheheptio.com/categories>Categories</a>
<a class=menu-item href=http://whattheheptio.com/about>About</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a></div></div></nav><nav class=navbar-mobile><div class=navbar-container><div class=navbar-header><div class="navbar-header-title animated bounceIn"><a href=http://whattheheptio.com>What the Heptio?</a></div><div class=menu-toggle id=menu-toggle><span></span><span></span><span></span></div></div><div class=navbar-menu id=mobile-menu><a class=menu-item href=http://whattheheptio.com/posts>Posts</a>
<a class=menu-item href=http://whattheheptio.com/tags>Tags</a>
<a class=menu-item href=http://whattheheptio.com/categories>Categories</a>
<a class=menu-item href=http://whattheheptio.com/about>About</a>
<a href=javascript:void(0); class=theme-switch><i class="fas fa-adjust fa-rotate-180 fa-fw"></i></a></div></div></nav><main class=main><div class=container><article class=post-warp><h1 class="post-title animated flipInX">Prometheus and Grafana: The Metric Monitoring Titans</h1><div class=post-meta><div class=post-meta-main><a class=author href=http://whattheheptio.com rel=author><i class="fas fa-user-circle fa-fw"></i>Tom Meadows&nbsp;</a>
<span class=post-category>included in
<i class="far fa-folder fa-fw"></i><a href=http://whattheheptio.com/categories/tools-and-platforms/>Tools and Platforms</a></span></div><div class=post-meta-other><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-03-04>2020-03-04</time>&nbsp;
<i class="fas fa-pencil-alt fa-fw"></i>about 1770 words&nbsp;
<i class="far fa-clock fa-fw"></i>9 min&nbsp;</div></div><div class=post-featured-image><img src=/images/loading.svg data-sizes=auto data-src=/img/04-Prometheus/cockpit.jpg alt="featured image" class=lazyload></div><div class=post-content><p>Your cloud native empire will never have looked so beautiful&mldr;</p><a class=post-dummy-target id=todays-post-anthem></a><h5>Todays Post Anthem</h5><iframe src=https://open.spotify.com/embed/track/1PWnAEQcbwQwK759otUbta width=300 height=80 frameborder=0 allowtransparency=true allow=encrypted-media></iframe><p><em>By &lsquo;writing&rsquo;&mldr; of course I mean metrics&mldr;</em></p><p>In my last article, I mentioned an open-source platform called Prometheus. Now if you are in any way involved with the cloud native ecosystem, you will probably have come across it. After all, it shares its name with a Greek Titan that starred in one of the world famous &lsquo;Alien&rsquo; movies üëΩ. But then I tell you that it is a monitoring and alerting toolkit that includes data scraping and storing, it&rsquo;s own querying language called &lsquo;PromQL&rsquo; and a built in alert manager. Yes, that sounds great&mldr; but&mldr; what does that mean? Well here we go again!</p><figure><img src=/img/04-Prometheus/prometheusmovie.gif><figcaption><h4>That look the sysadmin makes when he first sees a graph of his cluster metrics on Prometheus</h4></figcaption></figure><a class=post-dummy-target id=prometheus-what-the-heptio-></a><h2>Prometheus&mldr; What the Heptio? ü§∑‚Äç‚ôÇÔ∏è</h2><p>Now let&rsquo;s build ourselves a scenario. You&rsquo;re like me, and you&rsquo;ve just set up your first all singing, all dancing kubernetes cluster on GKE üéµ. Whether you know it or not (I definitely didn&rsquo;t to begin with), this is a very simple, turnkey experience. What I mean by this is that from go, a lot of the clusters components are setup for you, and their presence just fades into the background (within the darkest depths of the Google Cloud Platform üëª).</p><p>You think to yourself, &ldquo;I wonder how my cluster is performing&mldr; What pods are using up the most memory, how much traffic am I getting through my contour ingress controller?". Well.. that certainly is an interesting question. You have a scroll through the GCP web UI and the built in functions just throw it into your lap and you don&rsquo;t need to spare a second thought. But&mldr; where are those metrics really coming from? and if you hadn&rsquo;t asked yourself this question&mldr; and then spun up something more vanilla afterwards, like Kubeadm; why aren&rsquo;t these same capabilities just given to to me in the same way? Now we&rsquo;re talking üïµüèª‚Äç‚ôÇÔ∏è.</p><figure><img src=/img/04-Prometheus/GKEmonitoring.png><figcaption><h4>How it all looks under the hood</h4></figcaption></figure><p><a href=https://github.com/prometheus/prometheus>Prometheus</a> is a set of tools that you&rsquo;ll want to get for a thorough logging and monitoring experience on many container orchestrators. And what makes it so widely acclaimed? Well, a couple of things. First of all it has a powerfully simple querying language, so it&rsquo;s users can analyse their Kubernetes, Docker Swarm, Apache Mesos, Cloud Foundry&mldr; or just Kubernetes üôÉ clusters down to the minute details with ease.</p><p>Whats more? Prometheus was the second project to be officially supported by the Cloud Native Computing Foundation, along with Kubernetes and Envoy (mentioned in the first article for this <a href=https://www.whattheheptio.com/2020/02/first-posts/>blog</a>, take a look). This support gives a company that plans to integrate its applications with Prometheus tooling, the assurance that it will be an industry standard going into the future. For this reason, this makes it a perfect candidate for a metrics provider, and it has seen wide spread adoption; with people speculating that the number of organisations using it could be in the tens of thousands.</p><a class=post-dummy-target id=so-how-is-all-of-this-possible></a><h2>So how is all of this possible?</h2><p>So as I said in the previous section, Prometheus is far more than a Kubernetes concept. It doesn&rsquo;t stipulate on the application running, and it has the capability of using metrics on almost any application provided it is configured correctly. In general, it requires that the workload provides the metrics for it using two components:</p><ul><li>Prometheus Exporter: These are libraries and servers that do the job of exporting the metrics generated by applications/services in your environment as Prometheus friendly metrics üòä</li><li>Prometheus HTTP Endpoint: The exporter then sends these metrics to a HTTP endpoint, which is a port on the applications http address that sits open, providing the metrics that Prometheus requires for the amazing stuff it&rsquo;ll do later on.</li></ul><p>Ok, so how does Prometheus get hold of these metrics that are now spilling out of the configured port? Well, Prometheus has a server application conveniently named &lsquo;Prometheus Server&rsquo;, that &lsquo;scrapes&rsquo; up the metrics sitting on the aforementioned ports, organises them into a time series database (TSDB), and throws it into a storage volume somewhere, amazing</p><figure><img src=/img/04-Prometheus/PromArch.png><figcaption><h4>How it all looks under the hood</h4></figcaption></figure><a class=post-dummy-target id=but-i-thought-you-said-there-was-an-alert-manager></a><h3>But I thought you said there was an alert manager?</h3><p>Oh yes, you&rsquo;re right there. Prometheus does indeed have its own dedicated alert manager. Embedded within the Prometheus server are capabilities that allow the user to define alerting rules based on the metrics provide by the cluster. For instance, want to know when there is high request latency for a web page on your server? No problem. This can be done easily if you give the server a correctly configured alert rules yaml. For example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>groups</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>example<span class=w>
</span><span class=w>  </span><span class=k>rules</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>alert</span><span class=p>:</span><span class=w> </span>HighRequestLatency<span class=w>
</span><span class=w>    </span><span class=k>expr</span><span class=p>:</span><span class=w> </span>job<span class=p>:</span>request_latency_seconds<span class=p>:</span>mean5m{job=<span class=s2>&#34;myjob&#34;</span>}<span class=w> </span>&gt;<span class=w> </span><span class=m>0.5</span><span class=w>
</span><span class=w>    </span><span class=k>for</span><span class=p>:</span><span class=w> </span>10m<span class=w>
</span><span class=w>    </span><span class=k>labels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>severity</span><span class=p>:</span><span class=w> </span>page<span class=w>
</span><span class=w>    </span><span class=k>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>summary</span><span class=p>:</span><span class=w> </span>High<span class=w> </span>request<span class=w> </span>latency<span class=w>
</span></code></pre></td></tr></table></div></div><p>Wow, markdown makes putting yaml in a web article super easy üÜí. Anyway, where was I&mldr; ah yes.</p><p>Once this has been deployed to the prometheus server, any metrics that meet these alert conditions will send the relevant alert to the manager. The alert manager can be reached easily through a web ui, where you can view all the alerts sent from the server, or there is something jazzy called the Alertmanager webhook receiver üò≤. What does this mean? well it means you can have your alerts delivered to a service of your choice. such as? well, you name it; they do it. SMS, Email, Telegram, Slack, Microsoft Teams, ServiceNow, Zoom, Alibaba Dingtalk, Rocket Chat (looks so awesome). The list goes on. Now you truly can make yourself feel like you have your own starship enterprise.</p><figure><img src=/img/04-Prometheus/homerdoomed.gif></figure><a class=post-dummy-target id=promql-where-the-real-fun-begins-></a><h2>PromQL&mldr; Where the real fun begins üï∫</h2><p>As I mentioned, the Alertmanager does have it&rsquo;s own dedicated web-ui, and so does the Prometheus server. When you access the Prometheus web-ui (through a default port of 9090), you&rsquo;re faced with a pretty simple, yet bland looking interface. It has a simple text input box labelled &lsquo;Expression&rsquo;, with a button below it that says &lsquo;Execute&rsquo;. Very exciting, let&rsquo;s start playing.</p><figure><img src=/img/04-Prometheus/PromGUI.png><figcaption><h4>How it all looks under the hood</h4></figcaption></figure>So by 'Expression', Prometheus means that it intends for the user to input syntax that 'queries' for some metrics sitting on the Prometheus Database (TSDB). This will be your way of telling prometheus, "hey, fetch me the CPU utilisation data of all the containers running on my kubernetes cluster, and return it organised in a certain way. Then finally if all goes well, it'll plot that data in the graph box sat below in the GUI. But just like a any extraterrestrial being, you must ask yourself 'what language does it speak?'. Well thankfully, it isn't Clingon. In fact, its querying language, PromSQL, is one of the reasons why this tool has found such popularity. As you can see below, the syntax is actually very simple to understand.. a.k.a it's pretty much in plain english, hoorah! If you haven't deduced already, this example fetches the amount of http GET requests taking place in the staging, testing and development environments... easy üòÇ.<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>http_requests_total{environment=~&#34;staging|testing|development&#34;,method!=&#34;GET&#34;}
</code></pre></td></tr></table></div></div><a class=post-dummy-target id=but-i-was-hoping-for-something-prettier-></a><h2>But I was hoping for something prettier üíã</h2><p>Well to be honest&mldr; so was I. But don&rsquo;t worry, I have good news!</p><p>It&rsquo;s time for another mystical platform name into the mix&mldr; it&rsquo;s slick, it&rsquo;s shiny, it&rsquo;s&mldr;</p><figure><img src=/img/04-Prometheus/Grafana.png></figure><figure><img src=/img/04-Prometheus/Grafana.gif><figcaption><h4>I know right?</h4></figcaption></figure><p>So welcome to the magical land of <a href=https://github.com/grafana/grafana>Grafana</a>. Where you can make use of PromSQL and the prometheus server APIs to visualise your generated metrics on highly configurable dashboards. That&rsquo;s right, we&rsquo;ve just taken your Starship Enterprise to the next level üõ∞. Each dashboard consists of one or more panels that can be arranged into rows. Of course usually each panel on the dashboard is related to each other. So you would have for instance a dashboard of panels for information regarding your kubernetes clusters CPU/Mem/Disk utilisation, and another dashboard that displays the ingresses of your applications sitting within the cluster. Then you could even have another dashboard that showed the geographical location of each request to your site in real time&mldr; yes I absolutely need to look into doing it for this site üôå. The sky really is the limit&mldr; if it&rsquo;s data that can be hoovered up by prometheus into the database, it can be visualised on Grafana with some configuration. And what&rsquo;s even cooler? You can make specific dashboards public so that you can show them to friends&mldr; or uh&mldr; colleagues easily. Don&rsquo;t worry though, you will still have full access to your precious infrastructure under lock and key.</p><p>I hear you, I hear you, you want to see what this interface looks like in real life. Well good news! Thanks to the open-source attitude some organisations take towards these platforms, certain dashboards are available for anyone to look at. For instance, <a href="https://monit-grafana-open.cern.ch/d/000000523/home?orgId=16">CERN</a>, <a href=https://devstats.cncf.io/>CNCF</a>, the <a href="https://weather.hiveeyes.org/grafana/d/start/welcome?kiosk&orgId=1&refresh=15m">Beehive Project</a> and many more make some of their dashboards fully accessible for the world to see. I&rsquo;ve just wasted the last 30 minutes looking around them and they&rsquo;re amazing, so feel free to give them a look if you have any more free time.</p><a class=post-dummy-target id=im-sold-im-sold-how-do-i-get-it-on-my-kubernetes-cluster></a><h2>I&rsquo;m sold, i&rsquo;m sold! How do I get it on my Kubernetes cluster?</h2><p>How do you get it? Well that&rsquo;s maybe even better than the joys of the previous section. <a href=https://github.com/prometheus/prometheus>This</a> github repository named kube-prometheus is all you need to get yourself started with your very own Prometheus server, web UI, AlertManager, and even Grafana, to start viewing your empire like a king on day 0. I used it on GKE, and it was super easy to get going. In fact I feel this task was when things started to click in my head about kubernetes as a platform, which was very rewarding.</p><a class=post-dummy-target id=scraping-up-the-last-bits-and-pieces></a><h2>&lsquo;Scraping&rsquo; up the last bits and pieces</h2><p>So that&rsquo;s it. We&rsquo;ve gained some clarity on yet another cloud native tool, and taken a shallow dive into what is possible when Kubernetes teams up with Kubernetes and Grafana to give nerds like myself a full view of their estate; but also a window view for anyone else interested. For any organisation running Kubernetes or a cloud-native platform like it, these tools really are a no brainer&mldr; they are the industry standard&mldr; and well&mldr; why wouldn&rsquo;t you want to have what I just showed you? It&rsquo;s so awesome!</p><p>I&rsquo;ll leave you with another Youtube video, as this tends to be the standard way to finish these articles. Tom Wilkie, one of the Prometheus Developers, gave a great talk back in 2018, which gives a more thorough and detailed tour of the Prometheus world, and how that can be linked up with Grafana. So I hope you enjoyed this weeks instalment, and as always any feedback at all is more than welcome.</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube-nocookie.com/embed/kG9p417sC3I style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>This article is updated with 2020-04-22</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=http://whattheheptio.com/2020/03/04-prometheus/index.md target=_blank></a></span></div><div class=post-info-share><span><a href="//reddit.com/submit?url=http%3a%2f%2fwhattheheptio.com%2f2020%2f03%2f04-prometheus%2f&title=Prometheus%20and%20Grafana%3a%20The%20Metric%20Monitoring%20Titans" target=_blank title="Share on Reddit"><i class="fab fa-reddit fa-fw"></i></a><a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2fwhattheheptio.com%2f2020%2f03%2f04-prometheus%2f&title=Prometheus%20and%20Grafana%3a%20The%20Metric%20Monitoring%20Titans" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin fa-fw"></i></a></span></div></div></div><div class=post-info-more><section><span class=tag><a href=http://whattheheptio.com/tags/kubernetes/><i class="fas fa-tag fa-fw"></i>Kubernetes</a></span>
<span class=tag><a href=http://whattheheptio.com/tags/tools/><i class="fas fa-tag fa-fw"></i>Tools</a></span>
<span class=tag><a href=http://whattheheptio.com/tags/monitoring/><i class="fas fa-tag fa-fw"></i>Monitoring</a></span></section><section><span><a href=javascript:window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=http://whattheheptio.com>Home</a></span></section></div><div class=post-nav><a href=http://whattheheptio.com/2020/02/03-antrea/ class=prev rel=prev title="Antrea: Giving My Pods A Voice"><i class="fas fa-angle-left fa-fw"></i>Antrea: Giving My Pods A Voice</a>
<a href=http://whattheheptio.com/2020/04/05-velero/ class=next rel=next title="When disaster strikes, count on... Velero?">When disaster strikes, count on... Velero?<i class="fas fa-angle-right fa-fw"></i></a></div></div><div class=post-comment><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")
return;var dsq=document.createElement("script");dsq.type="text/javascript";dsq.async=true;var disqus_shortname="whattheheptio";dsq.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright><div class=copyright-line>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreffer">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a></div><div class=copyright-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=http://whattheheptio.com>Tom Meadows</a></span><span class=license>&nbsp;|&nbsp;<a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer><script src=/js/lib/jquery/jquery.slim.min.min.js></script><script src=/js/lib/lazysizes/lazysizes.min.min.js></script><script src=/js/lib/smooth-scroll/smooth-scroll.polyfills.min.min.js></script><script>window.scroll=new SmoothScroll('[data-scroll]',{speed:300,speedAsDuration:true});</script><script src=/js/blog.min.js></script></div><a href=# class=dynamic-to-top id=dynamic-to-top data-scroll><span>&nbsp;</span></a></body></html>